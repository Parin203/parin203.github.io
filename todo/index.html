<!doctype html>
<html ng-app="todoApp">
  <head>
    <title>Alfred on duty.</title>
    <script src="js/lib/jquery.min.js"></script>
    <script src="js/lib/angular.js"></script>
    
    <script src="js/lib/bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="js/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/my.css">
    <link rel="stylesheet" type="text/css" href="js/lib/bootstrap/css/bootstrap-responsive.min.css">
    <meta name='viewport' content="width=device-width,initial-scale=1.0">
  </head>
  <body ng-controller="myTodoCtrl" ng-init="show=false" >
      <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="navbar-inner">
            <div class="container-fluid">
              <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              {{hello}}
              <a class="brand" class="active" href="/todo">Welcome Master :) </a>
              <div class="nav-collapse collapse">
                <ul class="nav">
                  <!-- <li class="active"><a href="chrome-extension://gihkgljdimgfffabkemicpaeljmoobil/docs/examples/fluid.html#">Home</a></li>
                  <li><a href="chrome-extension://gihkgljdimgfffabkemicpaeljmoobil/docs/examples/fluid.html#about">About</a></li>
                  <li><a href="chrome-extension://gihkgljdimgfffabkemicpaeljmoobil/docs/examples/fluid.html#contact">Contact</a></li> -->
                </ul>
              </div><!--/.nav-collapse -->
            </div>
          </div>
      </div>
    <!-- <div class="container btn-inverse hero-unit"><h1>Daddy's Home</h1></div> -->
    <div class="" style="margin-top:50px">
      <div class="row-fluid ">
          <div class="span3 my_well">
            <form name="todo_form">
            <h1>Add ToDo</h1>
            <hr>
            <label><h4 style="display:inline">Title</h4></label><input type="text" ng-model="title"  name="title" required>
            <!--<span  class="error" ng-show="todo_form.title.$error.required"> Please Enter Value
            </span>-->
            <label><h4 style="display:inline">Duedate</h4></label> <input type="date" class="datepicker" name="duedate" ng-model="duedate" required >
            <!--<span<span  class="error" ng-show="todo_form.duedate.$error.required">Please Enter Value</span> -->
            <label><h4 style="display:inline">Description</h4></label><textarea  ng-model="description"  name="description"></textarea>

            <label><h4 style="display:inline">Priority</h4></label><input type="number"  ng-model="priority"  name="priority" required>
            <!--<span<span class="error"  ng-show="todo_form.priority.$error.required">Please Enter Number</span>
            -->

                <div  ng-hide="show" >
                    <label><h4 style="display:inline">Select Tags</h4></label>
                    <select ng-model="selected_tags" ng-change="show_tags=true" ng-options="tag for tag in tags" multiple required>
                    </select>
                    <input type="button"  class="btn btn-primary" ng-click="show=true" value="Add">
                </div >
                <div ng-show='show'>
                    <span >
                        <h4 style="display:inline">New Tag Name</h4>
                        <input type="text" ng-model="new_tag" >
                    </span>

                    <div>
                      <input type="button"  class="btn btn-success" ng-click="add_tag();new_tag='';show='false'" value="Add New">
                      <input type="button"  class="btn btn-danger" ng-click="show='false'" value="Cancel">
                    </div>
                </div>

            <hr>
            <input type="button" class="btn btn-primary" ng-click="add_entry()" ng-disabled="!todo_form.$valid" value="Add To List">
            <input type="button" class="btn btn-danger" ng-click="reset_form()"  value="Reset">

            </form>
          </div>
         <!-- list of todos -->
              <div class="span6 my_well">
              <h1> To Do List </h1>
              <div class="accordion" id="accordion2" class="span12">
                <div class="accordion-group" ng-animate="'animate'" ng-class="todo.class_var" ng-repeat="todo in todo_list | filter : query |  orderBy:'due_date' | orderBy:'priority'" >
                  <div class="accordion-heading" >
                      <a class="accordion-toggle" style="display:inline;" data-toggle="collapse" data-parent="#accordion2" href="#{{todo._id.$id}}">
                      <span class="span6">
                      <strong>&nbsp;&nbsp;{{todo.title |limitTo : 30}}</strong>
                      </span>
                    </a>
                    || {{todo.priority}} ||  <span class="text_red">{{todo.due_date}}</span> ||

                    <span >
                    <button class="btn  btn-success " ng-click="todo_done(todo._id.$id)">
                    <i class="icon icon-ok icon-white"></i></button>
                    <button class="btn  btn-inverse " ng-click="edit_entry(todo._id.$id)">
                    <i class="icon icon-pencil icon-white"></i></button>
                    <button class="btn  btn-danger " data-toggle="modal" ng-click="show_modal(todo._id.$id)">
                    <i class="icon icon-remove icon-white"></i></button>
                    </span>
                  </div>
                  <div id="{{todo._id.$id}}" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <div style="word-wrap:break-word" ng-bind="todo.description"></div>
                    </div>
                    <div>
                      <span class='my_tag label label-info' ng-repeat="tag in todo.tags">{{tag}}</span>
                      <span class="text_blue span2 pull-right">
                      {{todo.date_added}}
                      </span>
                    </div>

                  </div>
                </div>
              </div>
              </div>

              <!-- modal -->
              <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
              aria-hidden="true">
                <div class="modal-header">
                  <button type="button" class="btn btn-danger pull-right" data-dismiss="modal" aria-hidden="true"><i class="icon-remove icon-white"></i></button>
                  <h1 id="myModalLabel">You went full retard man :|</h1>
                </div>
                <div class="modal-body">
                  <h3>Are you sure you want to delete this todo ?</h3>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-danger" ng-click="hide_modal()">Oops :(</button>
                  <button class="btn btn-success" ng-click="delete()">Shut up Bitch..:)</button>
                </div>
              </div>

              <!-- search module -->
            <div class="span3 my_well">
              <h1> Filter </h1>
             <input type="text"  placeholder="anything" ng-model="query.$">
              <input type="date"  ng-model = "query.due_date" placeholder="Due Date">
              <input type="date"  ng-model = "query.date_added" placeholder="Date Added">
              <input type="text" placeholder="priority" ng-model = "query.priority" >
              <select ng-model="query.tags" ng-change="show_tags=true" ng-options="tag for tag in tags" multiple>
              </select>
              <input type="button" class="btn btn-inverse span10" value="Reset" ng-click="reset()">
            </div>
            </div>
    </div>
  <script type="text/javascript">
  //===============LIBRARIES=======================================================
  </script>

  <script>
  //===============CUSTOM JS=======================================================
  </script>
  <script>
  var app = angular.module('todoApp',[]);
  app.controller('myTodoCtrl',function ($scope,$http){
          $scope.insert_url = 'php/service_add.php';
          $scope.fetch_url = 'php/service_todo_list.php';
          $scope.delete_url = 'php/service_delete.php';
          $scope.delete_id = '';
          $scope.todo_list = [];
          $scope.tags = [];


          initialize_app();


        // ======================================================================
        $scope.show_modal = function(delete_id){
          $('#myModal').modal('show');
          $scope.delete_id= delete_id;
        }
        $scope.hide_modal = function(){
          $('#myModal').modal('hide');
          $scope.delete_id='';
        }

        $scope.delete = function(){
          $scope.delete_entry($scope.delete_id);
          $scope.hide_modal();
        }

        function initialize_app(){
                  //populate todo_list
                  server_get($scope.fetch_url);
        }
        function initialize_todo_list(data){
                $scope.todo_list = data;
                // angular.forEach(data, function(value, key){
                //   $scope.todo_list[value._id.$id] = value;
                // });
                // console.log(myob);
        }
        function initialize_tags(){
                // console.log(1+$scope.todo_list);
                // console.log('2 tags');
                angular.forEach($scope.todo_list, function(todo,index){
                    angular.forEach(todo.tags, function(tag, key){
                      if($scope.tags.indexOf(tag) == -1)
                            $scope.tags.push(tag);
                    });
                  });
                //console.log('end  tags');
        }

        $scope.add_tag = function(){
                                      var new_tag = $scope.new_tag;
                                      if( new_tag != null && $scope.tags.indexOf(new_tag) == -1){
                                          $scope.tags.push(new_tag);
                                      }
                                    }
        $scope.add_entry = function(){
                                      var todo = {};
                                      todo.title       =  $scope.title    ;
                                      todo.due_date    =  $scope.duedate  ;
                                      todo.description =  $scope.description;
                                      todo.priority    =  $scope.priority ; //highest=5,lowest=1
                                      todo.tags        =  $scope.selected_tags;
                                      post_todo(todo);
                                      console.log(todo);
                                      }
        $scope.edit_entry = function(id){
                                      var todo = {};
                                      todo.id          =  id;
                                      todo.title       =  $scope.title    ;
                                      todo.due_date    =  $scope.duedate  ;
                                      todo.description =  $scope.description;
                                      todo.priority    =  $scope.priority ; //highest=5,lowest=1
                                      todo.tags        =  $scope.selected_tags;
                                      post_todo(todo);
                                      console.log(todo);
                                      }
        $scope.delete_entry = function(id){
                                      var todo = {};
                                      todo.id = id;
                                      delete_todo(todo);
                                      console.log(id);
                                      }

        function delete_todo(todo){
                                 $http.post($scope.delete_url,todo)
                                              .success(function(data, status) {
                                                  console.log(status + data);
                                                  initialize_app();
                                                  $scope.reset_form();
                                                })
                                              .error(function(data, status) {
                                                  console.log(status + data);
                                              });
                                    }

        $scope.todo_done = function(index){
                                      var todo = {};
                                      todo.title       =  $scope.title    ;
                                      todo.due_date    =  $scope.duedate  ;
                                      todo.description =  $scope.description;
                                      todo.priority    =  $scope.priority ; //highest=5,lowest=1
                                      todo.tags        =  $scope.selected_tags;
                                      post_todo(todo);
                                      console.log(todo);
                                      }

       function post_todo(todo){
                                 $http.post($scope.insert_url,todo)
                                              .success(function(data, status) {
                                                  console.log(status + data);
                                                  initialize_app();
                                                  $scope.reset_form();
                                                })
                                              .error(function(data, status) {
                                                  console.log(status + data);
                                              });
       }

        function server_get(url){
                                $http.get(url)
                                    .success(function(data, status) {
                                                  // console.log(status + data);
                                                  initialize_todo_list(data);
                                                  initialize_tags();
                                                  //console.log($scope.todo_list);
                                      })
                                    .error(function(data, status) {
                                        console.log(status + data);
                                    });
        }

        //======================================================================
        $scope.reset_form   = function (){
              $scope.title    =undefined;
              $scope.duedate  =undefined;
              $scope.priority =undefined;
              $scope.description =undefined;
              $scope.selected_tags =undefined;
              $scope.query = undefined;
              //$scope.query.$ = undefined;
            }

        $scope.reset   = function (){
              $scope.query = undefined;
            }
        }
        );
  </script>

</body>
</html>